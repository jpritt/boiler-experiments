#PBS -q batch
#PBS -l walltime=720:00
#PBS -j n
#PBS -l pmem=16gb
#PBS -l vmem=16gb
#PBS -l pvmem=16gb
#PBS -m ae
#PBS -M mpritt4@jhu.edu
echo 'Compressing '$DIR
cd $DIR

mkdir -p hisat2_out
/scratch0/langmead-fs1/shared/hisat2-2.0.1-beta/hisat2 -x /scratch0/langmead-fs1/user/jacob/compress-alignments-test/drosophila/hisat2_index/index -1 reads1.fastq -2 reads2.fastq -S hisat2_out/accepted_hits.sam

# Remove pairs that reportedly failed to align. This has no effect on Stringtie results
/scratch0/langmead-fs1/user/jacob/boiler-experiments/scripts/filter_sam/removeUp.py hisat2_out/accepted_hits.sam hisat2_out/accepted_hits_no_up.sam

/scratch0/langmead-fs1/user/jacob/boiler/processHISAT.py --input hisat2_out/accepted_hits_no_up.sam --output hisat2_out/accepted_hits_processed.sam
samtools view -bS hisat2_out/accepted_hits_processed.sam | samtools sort - hisat2_out/accepted_hits_processed
samtools view -h -o hisat2_out/accepted_hits_processed.sam hisat2_out/accepted_hits_processed.bam

/scratch0/langmead-fs1/user/jacob/boiler-experiments/scripts/filter_sam/inferXStags.py hisat2_out/accepted_hits_processed.sam > hisat2_out/accepted_hits_fixed.sam
samtools view -bS hisat2_out/accepted_hits_fixed.sam | samtools sort - hisat2_out/accepted_hits_fixed
samtools view -h -o hisat2_out/accepted_hits_fixed.sam hisat2_out/accepted_hits_fixed.bam

mkdir -p compressed_hisat2
/scratch0/langmead-fs1/shared/pypy3-2.4-linux_x86_64-portable/bin/pypy3 /scratch0/langmead-fs1/user/jacob/boiler/boiler.py compress --split-discordant --split-diff-strands --frag-len-z-cutoff 0.125 hisat2_out/accepted_hits_fixed.sam compressed_hisat2/compressed.bin
/scratch0/langmead-fs1/shared/pypy3-2.4-linux_x86_64-portable/bin/pypy3 /scratch0/langmead-fs1/user/jacob/boiler/boiler.py decompress compressed_hisat2/compressed.bin expanded_hisat2.sam

samtools view -bS expanded_hisat2.sam | samtools sort - expanded_hisat2
mkdir -p stringtie/hisat2/comp/
/scratch0/langmead-fs1/shared/stringtie-1.0.3/stringtie expanded_hisat2.bam > stringtie/hisat2/comp/transcripts.gtf
mkdir -p stringtie/hisat2/orig/
/scratch0/langmead-fs1/shared/stringtie-1.0.3/stringtie hisat2_out/accepted_hits_fixed.bam > stringtie/hisat2/orig/transcripts.gtf

echo ''
echo 'Transcripts Compared to Truth'
/scratch0/langmead-fs1/user/jacob/boiler/compareToTruth.py ../all_reps/simulation.pro ../all_reps/genes_fixed_sorted.gtf stringtie/hisat2/orig/transcripts.gtf 1
/scratch0/langmead-fs1/user/jacob/boiler/compareToTruth.py ../all_reps/simulation.pro ../all_reps/genes_fixed_sorted.gtf stringtie/hisat2/comp/transcripts.gtf 1
echo '' 
echo '=== SAM Comparison ==='
/scratch0/langmead-fs1/user/jacob/boiler/compareSAMs.py --sam1 hisat2_out/accepted_hits_fixed.sam --sam2 expanded_hisat2.sam --out-frags frag_lens.txt
